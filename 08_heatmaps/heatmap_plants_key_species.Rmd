trait based heatmap for *plants*.

```{r, message=F}
library(ade4)
library(vegan)
library(metabaR)
library(cowplot)
library(dplyr)
library(reshape2)
library(stringr) # for string manipulation
library(data.table)
library(gplots) # to use heatmap.2

library(RColorBrewer) # to visualise color palette
library(dendextend) # to manage clustering dendrogram
library(colorspace)# to work with dendextend

library(ape)
library(tidytree)
library(tibble)
library(phylogram)
library(seqRFLP) 

dt<-readRDS("../00_R-repository/plants_r2_embl_98_agg_norm_lg")

# add sequence_id into motus table, for later use
dt$motus <- dt$motus %>% mutate(sequence_id=rownames(.)) %>% select(sequence_id, everything())

# update a species name
#dt$motus[dt$motus$TAXID==23810,]$SCIENTIFIC_NAME <- "Ailanthus altissimus"
```

*optional* **do when loaded _lg data**
```{r}
# aggregate motus
dt$reads <- exp(dt$reads)-1
dt<- aggregate_motus(dt, groups=dt$motus$TAXID, FUN = FUN_agg_motus_sum)
dt$reads <- log1p(dt$reads)
```


```{r, warning=F}
# exclude bad species assignments
sub <- subset_metabarlist(dt, "motus", !dt$motus$SCIENTIFIC_NAME %like% paste(c("sp." ,"subgen.", "var","sect","subsect","Group") , collapse="|"))

# exclude taxa without family info:
sub <- subset_metabarlist(sub, "motus", (!is.na(sub$motus$family_name) & sub$motus$family_name=="Asteraceae") |
                                         !is.na(sub$motus$genus_name))
```





Load database
Add a column indicating whether they are alpine taxa
```{r}
# opt 1: load trait table from TTT database
ttt <- read.csv("../16_add_trait/TTT_cleaned_dataset_v1.csv", header=T, sep=',', na.strings=c("","NA"))

# opt 2: manually load alpine taxa
alp_ls <- c("Senecio","Edraianthus" ,"Androsace","Pedicularis","Veronica","Phyteuma", "Doronicum",
"Calluna vulgaris","Bartsia alpina","Vaccinium vitis-idaea","Veronica alpina","Veronica aphylla","Oxyria digyna", "Arctous alpina", "Trifolium pallescens", "Arctostaphylos uva-ursi") #,"Saxifraga", "Saussurea", "Carex","Euphrasia",

# opt 3: load data from info flora (Flora Helvetica)
IF <- read.csv("../16_add_trait/info_flora_Checklist_simplified.csv",header=T, na.strings="") %>% filter(Rangstufe == "sp")
```

```{r}
# mark what species are present in info flora checklist 
sub$motus <- sub$motus %>% mutate(info_flora = sub$motus$species_name %in% paste(IF$Gattung, IF$Spezies, sep=" "))

# get a species list
IF_sp <- sub$motus[sub$motus$info_flora,]$species_name %>% unique

# non-cultivated plants: A, I, ni
ncul <- IF %>% filter(paste(IF$Gattung, IF$Spezies, sep=" ") %in% IF_sp) %>% filter(Indigenat.CH %in% c("I","A","I/N","A/N","ni"))

# cultivated plants: AC, NC
neo_cul <- IF %>% filter(paste(IF$Gattung, IF$Spezies, sep=" ") %in% IF_sp) %>% filter(Indigenat.CH %in% c(NA,"NC","AC","N"))
```


*subset taxa* 
```{r, warning=F}
# remove cultivated taxa
sub <- subset_metabarlist(sub,"motus", !sub$motus$species_name %in% paste(neo_cul$Gattung, neo_cul$Spezies,sep=" "))

# keep taxa registered in info flora
sub <- subset_metabarlist(sub,"motus", sub$motus$info_flora==T)


# clean up metabarlist
pcrs_keep <- rowSums(sub$reads) %>% as.data.frame %>% filter(.>0) %>% rownames
sub <- subset_metabarlist(sub, "pcrs", rownames(sub$pcrs) %in% pcrs_keep)
check_metabarlist(sub)
```





Aggregate pcrs by site, output *detection probability* or *mean read count*.

```{r, warning=F}
dt_st <- sub
dt_st$pcrs <- left_join(sub$pcrs, sub$samples %>% mutate(sample_id=rownames(.)), by="sample_id")
rownames(dt_st$pcrs) <- rownames(sub$pcrs)
dt_st$pcrs$sample_id <- dt_st$pcrs$site

# load the new 'samples' table: sites
sites<- read.table("../03_metabaR/surfsedi_sites.txt", header=T, sep='\t')
rownames(sites) <- sites$site
dt_st$samples <- sites 


# rate of detection, OR, mean read count at sites
data <- aggregate_pcrs(dt_st, FUN=FUN_agg_pcrs_mean)
```


**do** *optional: remove motus appearing in only 1 site, for better focused heatmap*
```{r, warning=F}
motus_fewer2 <- colSums((data$reads>0)*1) %>% as.data.frame %>% filter(.<2) %>% rownames

data <- subset_metabarlist(data, "motus", !data$motus$TAXID %in% motus_fewer2)
```




```{r}
# method for hclust
method="complete"

method="ward.D"
method="ward.D2"
method= "single"
method="average" 
method="mcquitty"
method="median"
method="centroid"
```


```{r}
pa <- (data$reads>0)*1 # presence-absence 
ab <- data$reads # rate of detection

# for manually reorder dend to make a visually better gradient:
# make a column dendrogram just to see the size of each group
dd <- hclust(dist(t(ab)), method=method)

cutree(dd, k=2) %>% table
plot(dd, label=F)
```


```{r}
# ordinary heatmap
ht<-
  ab %>% 
  heatmap.2(hclustfun=function(x) hclust(x, method = method),
           trace="none", # labRow = NA, 
          col=c("#FCFCFC",hcl.colors(7, "Greens2", rev = T), "#004616"),
          Rowv=NA) # add Rowv=NA to disallow row clustering

# mark alpine taxa
alp <- ifelse(data$motus[ht$colInd,]$alpine,data$motus[ht$colInd,]$SCIENTIFIC_NAME,NA)
# mark info flora non-cultivated flora
ifncul <- ifelse(data$motus[ht$colInd,]$species_name %in% paste(ncul$Gattung, ncul$Spezies, sep=" "), data$motus[ht$colInd,]$SCIENTIFIC_NAME, NA) # data$motus[ht$colInd,]$SCIENTIFIC_NAME "--"

# mark info flora cultivated flora
ifneo_cul <- ifelse(data$motus[ht$colInd,]$species_name %in% paste(neo_cul$Gattung, neo_cul$Spezies, sep=" "), "--", NA) #

# mark taxa
taxa <- ifelse(!is.na(data$motus[ht$colInd,]$species_name), data$motus[ht$colInd,]$species_name, data$motus[ht$colInd,]$genus_name)
```



```{r}
lmat <- rbind(c(1,3,4), c(2,1,4))
lhei <- c(0.5, 1)
lwid <- c(1.5, 4, 0.75)
par(oma=c(5,4,4,2))

ht<-
  ab %>% 
  heatmap.2(hclustfun=function(x) hclust(x, method = method), dendrogram = "none",
            lhei=lhei, lwid=lwid,lmat = lmat,
            trace="none", labCol = taxa,# labRow = NA, 
            col=c("#FCFCFC",hcl.colors(7, "Greens2", rev = T), "#004616"),
            Rowv=NA) # add Rowv=NA to disallow row clustering
```


```{r}
# save plot to local
#png('/Users/yiwang/Downloads/plants_hmp_keySp.png', width = 15, height = 10, units = 'in', res = 600)
pdf('/Users/yiwang/Downloads/plants_hmp_keySp.pdf', width = 15, height = 10)

# paste code here:
lmat <- rbind(c(1,3,4), c(2,1,4))
lhei <- c(0.5, 1)
lwid <- c(1.5, 4, 0.75)
par(oma=c(5,4,4,2))

ht<-
  ab %>% 
  heatmap.2(hclustfun=function(x) hclust(x, method = method), dendrogram = "none",
            lhei=lhei, lwid=lwid,lmat = lmat,
            trace="none", 
            labCol = as.expression(lapply(taxa, function(a) bquote(italic(.(a))))), 
            cexCol = 1.2, margins=c(12,8),adjCol=c(1,0.5),
            col=c("#FCFCFC",hcl.colors(7, "Greens2", rev = T), "#004616"),
            Rowv=NA) # add Rowv=NA to disallow row clustering

dev.off()
```































**Manually examine and modify each time!**
```{r}
# use the order in dendrogram for later use
# motuAgg:
ddorder <- c(ht$colInd[264:829], ht$colInd[1:263])
```




Categorize grown forms into groups
```{r}
data$motus <- data$motus %>% mutate(growth_form = ifelse(PlantGrowthForm %like% paste(c("tree" ,"shrub"), collapse="|"),
                                     "tree/shrub",
                                     PlantGrowthForm)) 
```



```{r}
motus_sorted <- data$motus %>% mutate(id=c(1:nrow(.))) %>% # give each ASV an id number
  slice(all_of(ddorder))# %>% # first order rows as in dendrogram so that it is kept later
  select(id, growth_form, PlantGrowthForm, Aquatic, class_name, order_name, family_name, genus_name, species_name, SCIENTIFIC_NAME) %>%
  arrange(., growth_form)#, order_name, family_name, genus_name, species_name, SCIENTIFIC_NAME)


ht<-
  ab %>% as.data.frame %>% 
  select(motus_sorted$id)%>% as.matrix %>% # reorder matrix based on tree, since heatmap.2 doesn't do it automatically
  heatmap.2(hclustfun=function(x) hclust(x, method = 'ward.D2'),
          labRow = NA, 
          labCol = motus_sorted$PlantGrowthForm, srtCol = 90, # labCol=new_tip$conservative_tax_new or $dot
          trace="none",key=T,
          col=c("#FCFCFC",hcl.colors(7, "Greens2", rev = T), "#004616"),
          Colv = NA,Rowv=NA, # ,Colv = drt # remove ,Rowv=NA to let rows cluster
          cexCol=0.8)# + geom_label_repel()

```














```{r}
# get the matrix of heatmap and add identification
mat <- ht$carpet %>% as.data.frame %>% mutate(TAXID=as.numeric(rownames(.))) %>% left_join(., data$motus %>% select(TAXID, SCIENTIFIC_NAME), by="TAXID")
```

```{r}
# print names of selected rows of taxa
start <- which(grepl(3319, mat$TAXID))
end <- which(grepl(4022, mat$TAXID))

names <- mat %>% select(TAXID, SCIENTIFIC_NAME) %>% slice(start:end) %>% select(SCIENTIFIC_NAME)

write.table(names, "/Users/yiwang/Downloads/names.txt", sep="\n",row.names =F,col.names =F, quote = F)
```



```{r}
# prepare new tree tip labels: change nx_new_rt$tip.label to colnames of "ab", so that heatmap can use the tree in plotting
new_tip <- left_join(tree$tip.label %>% as.data.frame %>% `colnames<-`("SCIENTIFIC_NAME"), 
                     data$motus %>% mutate(id=rownames(.)) %>% select(SCIENTIFIC_NAME,id),
                     by="SCIENTIFIC_NAME")

nx_new_rt$tip.label<-new_tip$id



# dendrogram of taxonomy tree
dtx <-phylogram::as.dendrogram.phylo(tree)
labels(dtx)<-NULL;plot(dtx)
```



```{r}
# heatmap, using phylo tree
ht<-
  ab %>% as.data.frame %>% 
  select(new_tip$id)%>% as.matrix %>% # reorder matrix based on tree, since heatmap.2 doesn't do it (no idea why)
  heatmap.2(hclustfun=function(x) hclust(x, method = 'average'),
          labRow = NA, labCol = NA, trace="none",
          col=hcl.colors(12, "Oslo", rev = F)
          ,Colv = dtx,Rowv=NA) # ,Colv = drt # add ,Rowv=NA to disallow rows cluster
```























